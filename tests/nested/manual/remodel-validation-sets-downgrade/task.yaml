summary: |
  Verify remodel will fail if model contains snap that is invalid in a
  validation set that is referenced in the model.

systems: [ubuntu-22.04-64]

environment:
  NESTED_CUSTOM_MODEL: $TESTSLIB/assertions/test-snapd-remodel-without-vset-pc-{VERSION}.model
  NESTED_ENABLE_TPM: true
  NESTED_ENABLE_SECURE_BOOT: true
  NESTED_BUILD_SNAPD_FROM_CURRENT: true

prepare: |
    tests.nested build-image core
    tests.nested create-vm core

execute: |
    # shellcheck source=tests/lib/nested.sh
    . "$TESTSLIB/nested.sh"

    boot_id="$(tests.nested boot-id)"

    remote.exec snap model | MATCH 'model +my-model$'

    # wait until device is initialized and has a serial
    remote.wait-for device-initialized

    # Get the nested system version
    VERSION="$(tests.nested show version)"

    remote.push "${TESTSLIB}/assertions/test-snapd-remodel-pinned-hello-world-pc-${VERSION}.model"

    # make sure it is installed, but it shouldn't be at the pinned revision, 28
    remote.exec snap info hello-world | grep installed | awk '{print $3}' | not MATCH '(28)'

    change_id="$(remote.exec sudo snap remodel --no-wait "test-snapd-remodel-pinned-hello-world-pc-${VERSION}.model")"
    remote.wait-for reboot "${boot_id}"
    remote.exec sudo snap watch "${change_id}"

    # make sure that the remodel downgraded the snap
    snap info hello-world | grep installed | awk '{print $3}' | MATCH '(28)'
