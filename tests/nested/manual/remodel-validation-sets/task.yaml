summary: |
  Verify remodel will fail if model contains snap that is invalid in a
  validation set that is referenced in the model.

systems: [ubuntu-22.04-64]

environment:
  NESTED_CUSTOM_MODEL: $TESTSLIB/assertions/test-snapd-remodel-without-vset-pc-{VERSION}.model
  NESTED_ENABLE_TPM: true
  NESTED_ENABLE_SECURE_BOOT: true
  NESTED_BUILD_SNAPD_FROM_CURRENT: true

prepare: |
    tests.nested build-image core
    tests.nested create-vm core

execute: |
    # shellcheck source=tests/lib/nested.sh
    . "$TESTSLIB/nested.sh"
    remote.exec snap model | MATCH 'model +my-model$'

    # wait until device is initialized and has a serial
    remote.wait-for device-initialized

    # Get the nested system version
    VERSION="$(tests.nested show version)"

    echo "Refresh model assertion to revision 2"
    
    remote.push "$TESTSLIB/assertions/test-snapd-remodel-invalid-vset-pc-$VERSION.model"
    not remote.exec sudo snap remodel "test-snapd-remodel-invalid-vset-pc-$VERSION.model"
